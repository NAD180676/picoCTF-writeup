AUTHOR: WILL HONG | 		Medium, BinaryExploitation

Here's a program that plays rock, paper, scissors against you. I hear something good happens if you win 5 times in a row.

The program's source code with the flag redacted can be downloaded [here](https://artifacts.picoctf.net/c/145/game-redacted.c).

Additional details will be available after launching your challenge instance.

----------------------------------------------------------------------------------------------------------------------------------------

First, use the 'wget' command to get the file, then we use cat game-redacted.c to read what inside the file.

         
          #include <stdio.h>
          #include <stdlib.h>
          #include <stdbool.h>
          #include <string.h>
          #include <time.h>
          #include <unistd.h>
          #include <sys/time.h>
          #include <sys/types.h>
          
          
          #define WAIT 60
          
          
          
          static const char* flag = "[REDACTED]";
          
          char* hands[3] = {"rock", "paper", "scissors"};
          char* loses[3] = {"paper", "scissors", "rock"};
          int wins = 0;
          
          
          
          int tgetinput(char *input, unsigned int l)
          {
              fd_set          input_set;
              struct timeval  timeout;
              int             ready_for_reading = 0;
              int             read_bytes = 0;
              
              if( l <= 0 )
              {
                printf("'l' for tgetinput must be greater than 0\n");
                return -2;
              }
              
              
              /* Empty the FD Set */
              FD_ZERO(&input_set );
              /* Listen to the input descriptor */
              FD_SET(STDIN_FILENO, &input_set);
          
              /* Waiting for some seconds */
              timeout.tv_sec = WAIT;    // WAIT seconds
              timeout.tv_usec = 0;    // 0 milliseconds
          
              /* Listening for input stream for any activity */
              ready_for_reading = select(1, &input_set, NULL, NULL, &timeout);
              /* Here, first parameter is number of FDs in the set, 
               * second is our FD set for reading,
               * third is the FD set in which any write activity needs to updated,
               * which is not required in this case. 
               * Fourth is timeout
               */
          
              if (ready_for_reading == -1) {
                  /* Some error has occured in input */
                  printf("Unable to read your input\n");
                  return -1;
              } 
          
              if (ready_for_reading) {
                  read_bytes = read(0, input, l-1);
                  if(input[read_bytes-1]=='\n'){
                  --read_bytes;
                  input[read_bytes]='\0';
                  }
                  if(read_bytes==0){
                      printf("No data given.\n");
                      return -4;
                  } else {
                      return 0;
                  }
              } else {
                  printf("Timed out waiting for user input. Press Ctrl-C to disconnect\n");
                  return -3;
              }
          
              return 0;
          }
          
          
          bool play () {
            char player_turn[100];
            srand(time(0));
            int r;
          
            printf("Please make your selection (rock/paper/scissors):\n");
            r = tgetinput(player_turn, 100);
            // Timeout on user input
            if(r == -3)
            {
              printf("Goodbye!\n");
              exit(0);
            }
          
            int computer_turn = rand() % 3;
            printf("You played: %s\n", player_turn);
            printf("The computer played: %s\n", hands[computer_turn]);
          
            if (strstr(player_turn, loses[computer_turn])) {                                  <=============
              puts("You win! Play again?");
              return true;
            } else {
              puts("Seems like you didn't win this time. Play again?");
              return false;
            }
          }
          
          
          int main () {
            char input[3] = {'\0'};
            int command;
            int r;
          
            puts("Welcome challenger to the game of Rock, Paper, Scissors");
            puts("For anyone that beats me 5 times in a row, I will offer up a flag I found");
            puts("Are you ready?");
            
            while (true) {
              puts("Type '1' to play a game");
              puts("Type '2' to exit the program");
              r = tgetinput(input, 3);
              // Timeout on user input
              if(r == -3)
              {
                printf("Goodbye!\n");
                exit(0);
              }
              
              if ((command = strtol(input, NULL, 10)) == 0) {
                puts("Please put in a valid number");
                
              } else if (command == 1) {
                printf("\n\n");
                if (play()) {
                  wins++;
                } else {
                  wins = 0;
                }
          
                if (wins >= 5) {
                  puts("Congrats, here's the flag!");
                  puts(flag);
                }
              } else if (command == 2) {
                return 0;
              } else {
                puts("Please type either 1 or 2");
              }
            }
          
            return 0;
    }


As we can see, the file showing us a normal rock, paper, scissors game. We can "SOMEHOW" win if we lucky enough and without checking anything

Unfortunately, I am not that lucky, so let's check what is intresting in here?

As we see from the hint "How does the program check if you won?". Well, just to make sure, I tried to play a few times, and I noticed if I won, it will show "You win! Play Again?", so that I could indicate where is the checking win/lose function is. It's in the play(). 
As we can see, the computer move will be completely random and we have nothing to change that, so we will have to go pass it, check at these specific lines of code

        int computer_turn = rand() % 3;
              printf("You played: %s\n", player_turn);
              printf("The computer played: %s\n", hands[computer_turn]);
        if (strstr(player_turn, loses[computer_turn])) {                                
              puts("You win! Play again?");
              return true;
            } else {
              puts("Seems like you didn't win this time. Play again?");
              return false;
            }

Take a look at 'strstr()', this method is similar to find() in python, however instead of returning index of the match(or -1), the strstr() will return pointer to the match(or NULL), and it has *CaseSensitivity.
So these line of code will happen after player entered their move and can be understand like this:

    1. Computer will generate a number that will calculate modulas with 3, if it return 1 -> computer.move = rock; 2-> paper; 3 -> scissors (we can check this at the beginning of the program) as well as it will save the move that the computer will lose to, that information is contained in the loses[3] array right below the hands[3], similarly to assign move for computer, when the computer got assign the move, the move it lose to will be called as well.
    
    2. Then it will print player's move, as well as computer's move
    
    3. The if statement will check if player's move with the move that computer's move lost to is the same or not
        For e.g: C.move = rock, C.MoveLT(move lose to) = paper; P.move = paper -> if P.move = C.MoveLT => win; else lose;
        
However computer is completely random so we can bypass that by write down 3 moves in 1 play, just **repeatedly type in "rockpaperscissors" 5 times, then you will get the flag** and remember it's case sensitivity.

-------------------------------------------------------------------------------------------------------------------------------

Flag: picoCTF{-----------------}
